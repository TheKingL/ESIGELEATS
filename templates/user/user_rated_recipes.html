{% extends "layout.html" %}
{% block title %}Recettes notées{% endblock %}
{% block content %}
    <div class="container max-w-3xl py-10 space-y-8">
        <h1 class="text-2xl font-display font-semibold text-primary-700 dark:text-primary-100">Recettes notées</h1>
        <!-- Boutons de tri -->
        <div class="flex gap-3">
            <button id="sort-best"
                    class="px-3 py-1.5 rounded-full bg-amber-100 text-amber-700 text-xs font-semibold hover:bg-amber-200 hover:text-amber-800 dark:bg-amber-900/40 dark:text-amber-300 dark:hover:bg-amber-900/60 dark:hover:text-amber-200">
                <i class="fa-solid fa-arrow-down-short-wide"></i>
                Meilleures → Pires
            </button>
            <button id="sort-worst"
                    class="px-3 py-1.5 rounded-full bg-rose-100 text-rose-700 text-xs font-semibold hover:bg-rose-200 hover:text-rose-800 dark:bg-rose-900/40 dark:text-rose-300 dark:hover:bg-rose-900/60 dark:hover:text-rose-200">
                <i class="fa-solid fa-arrow-down-short-wide"></i>
                Pires → Meilleures
            </button>
            <button id="sort-date"
                    class="px-3 py-1.5 rounded-full bg-primary-100 text-primary-700 text-xs font-semibold hover:bg-primary-200 hover:text-primary-800 dark:bg-primary-900/40 dark:text-primary-200 dark:hover:bg-primary-900/60 dark:hover:text-primary-100">
                <i class="fa-solid fa-calendar-days"></i>
                Récent → Ancien
            </button>
        </div>
        <div id="rated-list" class="space-y-4 mt-4">
            <p class="text-sm text-ink-soft dark:text-ink-lighter">Chargement...</p>
        </div>
    </div>
    <script>
document.addEventListener("DOMContentLoaded", () => {
    const list = document.getElementById("rated-list");
    let recipes = [];

    function render() {
        if (recipes.length === 0) {
            list.innerHTML = `
                <div class="rounded-2xl bg-surface-light p-6 text-center text-sm text-ink-soft dark:bg-surface-dark dark:text-ink-lighter">
                    Aucune recette notée.
                </div>`;
            return;
        }

        list.innerHTML = "";

        recipes.forEach(r => {
            const img = r.image_path
                ? `/static/${r.image_path}`
                : `/static/img/default_recipe.png`;

            const stars = r.average_rating
                ? `<p class="text-xs text-amber-600 dark:text-amber-300">
                     <i class="fa-solid fa-star text-amber-400"></i>
                     ${r.average_rating.toFixed(1)} / 5
                   </p>`
                : `<p class="text-xs text-ink-soft dark:text-ink-lighter">Pas encore de note</p>`;

            list.innerHTML += `
                <a href="/recipes/${r.id}" class="group flex items-center justify-between rounded-2xl border border-primary-100 bg-surface-light p-4 shadow-sm hover:border-primary-300 hover:bg-primary-50/60 dark:border-primary-700/60 dark:bg-surface-dark dark:hover:border-primary-500 dark:hover:bg-primary-700/25">

                    <div class="flex items-center gap-4">

                        <div class="h-16 w-16 overflow-hidden rounded-xl shadow">
                            <img src="${img}" class="h-full w-full object-cover" />
                        </div>

                        <div>
                            <p class="font-semibold text-ink dark:text-ink-inverted">
                                ${r.title}
                            </p>

                            <p class="text-xs text-ink-soft dark:text-ink-lighter">
                                Notée le : <span class="font-medium">${r.rating_date}</span>
                            </p>

                            <p class="text-xs text-amber-600 dark:text-amber-300">
                                <i class="fa-solid fa-star text-amber-400"></i>
                                Votre note : ${r.user_rating}
                            </p>

                            ${stars}
                        </div>
                    </div>

                    <i class="fa-solid fa-chevron-right text-[11px] text-ink-soft group-hover:text-primary-700 dark:text-ink-lighter dark:group-hover:text-primary-100"></i>
                </a>
            `;
        });
    }

    function sortByBest() {
        recipes.sort((a, b) => b.user_rating - a.user_rating);
        render();
    }

    function sortByWorst() {
        recipes.sort((a, b) => a.user_rating - b.user_rating);
        render();
    }

    function sortByDate() {
        recipes.sort((a, b) => new Date(b.rating_date) - new Date(a.rating_date));
        render();
    }

    fetch("{{ url_for('api.rated_recipes', user_id=viewed_user.id) }}")
        .then(res => res.json())
        .then(data => {
            recipes = data.recipes || [];
            sortByDate(); // tri par défaut
        });

    document.getElementById("sort-best").onclick = sortByBest;
    document.getElementById("sort-worst").onclick = sortByWorst;
    document.getElementById("sort-date").onclick = sortByDate;
});
    </script>
{% endblock %}
