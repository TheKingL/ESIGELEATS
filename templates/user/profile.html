{% extends "layout.html" %}
{% from "components/buttons.html" import button %}
{% from "components/notifications.html" import notif_pill %}
{% set is_owner = current_user and current_user.id == viewed_user.id %}
{% set is_admin = current_user and current_user.is_admin %}
{% set can_manage = is_owner or is_admin %}
{% set can_view_activity = viewed_user.is_profile_public or can_manage %}
{% block title %}Profil de {{ viewed_user.display_name or viewed_user.username }}{% endblock %}
{% block content %}
    <div class="container max-w-3xl py-10 space-y-8">
        <div class="rounded-2xl border border-primary-100 bg-surface-light p-6 shadow-lg dark:border-primary-700/50 dark:bg-surface-dark">
            <div class="flex items-center gap-6">
                <div class="flex h-20 w-20 items-center justify-center rounded-full bg-primary-100 text-3xl font-bold text-primary-700 dark:bg-primary-700/40 dark:text-primary-200">
                    {{ viewed_user.display_name[0] if viewed_user.display_name else viewed_user.username[0] }}
                </div>
                <div class="flex flex-col gap-1">
                    <h1 class="text-2xl font-display font-semibold text-primary-700 dark:text-primary-100">
                        {{ viewed_user.display_name or viewed_user.username }}
                    </h1>
                    <span class="text-sm text-ink-soft dark:text-ink-lighter">@{{ viewed_user.username }}</span>
                    {% if viewed_user.is_admin %}
                        <span class="mt-2 flex flex-row justify-center items-center gap-2 text-xs rounded-full bg-red-100 py-1 px-3 font-medium text-red-700 dark:bg-red-900/40 dark:text-red-300">
                            <i class="fa-solid fa-shield-halved text-xs"></i>
                            Administrateur
                        </span>
                    {% endif %}
                </div>
            </div>
            {% if viewed_user.bio %}
                <p class="mt-6 text-sm leading-relaxed text-ink-soft dark:text-ink-lighter">{{ viewed_user.bio }}</p>
            {% endif %}
            {% if can_manage %}
                <div class="mt-6 flex flex-wrap gap-3">
                    {{ button("Modifier mon profil",
                                        "primary",
                                        "fa-solid fa-user-pen",
                                        href=url_for('users.edit_user_profile', user_id=viewed_user.id) 
                    ) }}
                    {{ button("Modifier le mot de passe",
                                        "secondary",
                                        "fa-solid fa-key",
                                        href=url_for('users.edit_user_password', user_id=viewed_user.id) 
                    ) }}
                </div>
            {% endif %}
        </div>
        <div class="space-y-4 rounded-2xl border border-primary-100 bg-surface-light p-6 shadow-lg dark:border-primary-700/50 dark:bg-surface-dark">
            <h2 class="text-lg font-display font-semibold text-primary-700 dark:text-primary-100">Informations du compte</h2>
            <div class="grid grid-cols-1 gap-4 text-sm sm:grid-cols-2">
                <div>
                    <p class="text-ink-soft dark:text-ink-lighter">Profil :</p>
                    <p class="font-medium">
                        {% if viewed_user.is_profile_public %}
                            <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-0.5 text-xs font-semibold text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300">
                                Public
                            </span>
                        {% else %}
                            <span class="inline-flex items-center gap-1 rounded-full bg-rose-50 px-2.5 py-0.5 text-xs font-semibold text-rose-700 dark:bg-rose-900/40 dark:text-rose-300">
                                Privé
                            </span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-ink-soft dark:text-ink-lighter">Dernière connexion :</p>
                    <p class="font-medium">{{ viewed_user.last_login or "Jamais" }}</p>
                </div>
                <div>
                    <p class="text-ink-soft dark:text-ink-lighter">Créé le :</p>
                    <p class="font-medium">{{ viewed_user.created_at }}</p>
                </div>
                <div>
                    <p class="text-ink-soft dark:text-ink-lighter">Mis à jour le :</p>
                    <p class="font-medium">{{ viewed_user.updated_at or "Jamais" }}</p>
                </div>
            </div>
        </div>
        {% if can_view_activity %}
            <div class="space-y-4 rounded-2xl border border-primary-100 bg-surface-light p-6 shadow-lg dark:border-primary-700/50 dark:bg-surface-dark">
                <h2 class="text-lg font-display font-semibold text-primary-700 dark:text-primary-100">
                    {% if is_owner %}
                        Mes recettes et activité
                    {% else %}
                        Ses recettes et activité
                    {% endif %}
                </h2>
                <div class="space-y-3">
                    <a href="{{ url_for('users.user_recipes', user_id=viewed_user.id) }}"
                       class="group flex items-center justify-between rounded-2xl border border-primary-100 bg-surface-soft px-4 py-3 text-sm shadow-sm transition-colors ease-linear duration-300 hover:border-primary-300 hover:bg-primary-50/70 dark:border-primary-700/60 dark:bg-surface-dark dark:hover:border-primary-500 dark:hover:bg-primary-700/25">
                        <div class="flex items-center gap-3">
                            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-primary-100 text-primary-700 dark:bg-primary-700/40 dark:text-primary-100">
                                <i class="fa-solid fa-book-open text-sm"></i>
                            </span>
                            <div class="space-y-1">
                                <p class="flex flex-row items-center text-sm font-semibold text-ink dark:text-ink-inverted">
                                    {% if is_owner %}
                                        Mes recettes
                                    {% else %}
                                        Ses recettes
                                    {% endif %}
                                    {% if is_owner %}
                                        {{ notif_pill("changes-required",
                                                                                navbar_changes_required_count if navbar_changes_required_count is defined else 0,
                                                                                "ml-1") }}
                                    {% endif %}
                                </p>
                                <div class="flex flex-wrap gap-1.5 text-[11px]">
                                    <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2.5 py-0.5 font-medium text-amber-800 dark:bg-amber-900/50 dark:text-amber-200">
                                        <span class="h-1.5 w-1.5 rounded-full bg-amber-500"></span>
                                        En attente
                                    </span>
                                    <span class="inline-flex items-center gap-1 rounded-full bg-orange-100 px-2.5 py-0.5 font-medium text-orange-800 dark:bg-orange-900/50 dark:text-orange-200">
                                        <span class="h-1.5 w-1.5 rounded-full bg-orange-500"></span>
                                        À modifier
                                    </span>
                                    <span class="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2.5 py-0.5 font-medium text-emerald-800 dark:bg-emerald-900/50 dark:text-emerald-200">
                                        <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                                        Validées
                                    </span>
                                    <span class="inline-flex items-center gap-1 rounded-full bg-rose-100 px-2.5 py-0.5 font-medium text-rose-800 dark:bg-rose-900/50 dark:text-rose-200">
                                        <span class="h-1.5 w-1.5 rounded-full bg-rose-500"></span>
                                        Refusées
                                    </span>
                                </div>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right self-center text-[11px] text-ink-soft transition-colors ease-linear duration-300 group-hover:text-primary-700 dark:text-ink-lighter dark:group-hover:text-primary-100"></i>
                    </a>
                    <a href="{{ url_for('users.favorite_recipes', user_id=viewed_user.id) }}"
                       class="group flex items-center justify-between rounded-2xl border border-primary-100 bg-surface-soft px-4 py-3 text-sm shadow-sm transition-colors ease-linear duration-300 hover:border-primary-300 hover:bg-primary-50/70 dark:border-primary-700/60 dark:bg-surface-dark dark:hover:border-primary-500 dark:hover:bg-primary-700/25">
                        <div class="flex items-center gap-3">
                            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-rose-100 text-rose-600 dark:bg-rose-900/40 dark:text-rose-300">
                                <i class="fa-solid fa-heart text-sm"></i>
                            </span>
                            <div class="space-y-1">
                                <p class="text-sm font-semibold text-ink dark:text-ink-inverted">Recettes favorites</p>
                                <div class="flex flex-wrap gap-1.5 text-[11px]">
                                    <span class="inline-flex items-center gap-1 rounded-full bg-surface-light px-2.5 py-0.5 font-medium text-ink-soft dark:bg-surface-dark dark:text-ink-lighter">
                                        <i class="fa-solid fa-clock-rotate-left text-[10px]"></i>
                                        Tri par date (récent → ancien)
                                    </span>
                                </div>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right self-center text-[11px] text-ink-soft transition-colors ease-linear duration-300 group-hover:text-primary-700 dark:text-ink-lighter dark:group-hover:text-primary-100"></i>
                    </a>
                    <a href="{{ url_for('users.rated_recipes_page', user_id=viewed_user.id) }}"
                       class="group flex items-center justify-between rounded-2xl border border-primary-100 bg-surface-soft px-4 py-3 text-sm shadow-sm transition-colors ease-linear duration-300 hover:border-primary-300 hover:bg-primary-50/70 dark:border-primary-700/60 dark:bg-surface-dark dark:hover:border-primary-500 dark:hover:bg-primary-700/25">
                        <div class="flex items-center gap-3">
                            <span class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300">
                                <i class="fa-solid fa-star text-sm"></i>
                            </span>
                            <div class="space-y-1">
                                <p class="text-sm font-semibold text-ink dark:text-ink-inverted">Recettes notées</p>
                                <div class="flex flex-wrap gap-1.5 text-[11px]">
                                    <span class="inline-flex items-center gap-1 rounded-full bg-surface-light px-2.5 py-0.5 font-medium text-ink-soft dark:bg-surface-dark dark:text-ink-lighter">
                                        <i class="fa-solid fa-arrow-down-short-wide text-[10px]"></i>
                                        Tri par note
                                    </span>
                                    <span class="inline-flex items-center gap-1 rounded-full bg-surface-light px-2.5 py-0.5 font-medium text-ink-soft dark:bg-surface-dark dark:text-ink-lighter">
                                        <i class="fa-solid fa-clock text-[10px]"></i>
                                        Tri par date
                                    </span>
                                </div>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right self-center text-[11px] text-ink-soft transition-colors ease-linear duration-300 group-hover:text-primary-700 dark:text-ink-lighter dark:group-hover:text-primary-100"></i>
                    </a>
                </div>
                {% if can_manage %}
                    <div class="mt-6 border-t border-primary-100/70 pt-4 text-sm dark:border-primary-700/60">
                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <div class="max-w-md text-xs text-ink-soft dark:text-ink-lighter">
                                La suppression du compte entraîne la suppression de vos recettes, favoris et notes. Cette action est définitive.
                            </div>
                            <form method="post"
                                  action="{{ url_for('users.delete_user', user_id=viewed_user.id) }}"
                                  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce compte ? Cette action est irréversible.');">
                                {{ button("Supprimer ce compte",
                                                                "danger",
                                                                "fa-solid fa-user-slash",
                                                                type="submit") }}
                            </form>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
{% endblock %}
