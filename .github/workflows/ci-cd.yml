name: ğŸš€ CI/CD - Esigeleats

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  quality:
    name: ğŸ” QualitÃ© (Lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸŒª Ruff (Linter & Format)
        run: |
          echo "VÃ©rification avec Ruff..."
          ruff check .
          ruff format .

      - name: ğŸ¥’ DjLint (Templates Jinja)
        run: |
          echo "VÃ©rification des templates..."
          djlint templates/ --profile=jinja --check

      - name: ğŸ§ Pylint (Score check)
        run: |
          echo "ExÃ©cution de Pylint sur les dossiers clÃ©s..."
          pylint controllers models routes tests utils app.py > pylint_output.txt || true
          
          echo "==== RÃ©sultat Pylint ===="
          cat pylint_output.txt
          
          SCORE=$(grep -oP "(?<=rated at )[\d\.]+" pylint_output.txt || echo "0")
          echo "Score pylint dÃ©tectÃ© : $SCORE / 10"
          
          python3 - <<EOF
          import sys
          try:
              score = float("$SCORE")
          except ValueError:
              score = 0
          
          if score < 7.0:
              print(f"âŒ Score Pylint insuffisant ({score}/10). Minimum requis : 7.0")
              sys.exit(1)
          else:
              print(f"âœ… Score Pylint validÃ© ({score}/10). C'est carrÃ©.")
          EOF

  tests:
    name: ğŸ§ª Tests Unitaires
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ›¡ Configurer SECRET_KEY pour les tests
        run: echo "SECRET_KEY=cle_secrete_pour_les_tests_bang_bang" >> .env

      - name: ğŸ“‚ Initialiser la BDD pour les tests
        run: |
          echo "CrÃ©ation de la base de donnÃ©es..."
          pip install pysqlite3
          sqlite3 database.db < sql/setupdb.sql
          echo "âœ… Base de donnÃ©es crÃ©Ã©e !"

      - name: ğŸš€ Lancer les tests avec Coverage
        run: |
          coverage run --source=routes/ -m pytest
          coverage report
          coverage report --fail-under=70

  build:
    name: ğŸ³ Docker Build (Check)
    runs-on: ubuntu-latest
    needs: tests
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t esigeleats:latest .